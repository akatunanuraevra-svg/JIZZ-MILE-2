<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIZZ - Global Music Platform</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            color: white;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* NAVIGATION */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        .nav-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: #4ecdc4; }
        
        /* BUTTONS */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3); }
        .btn-outline {
            background: transparent;
            border: 2px solid #4ecdc4;
            color: #4ecdc4;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        /* HERO SECTION */
        .hero {
            height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                        url('https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 1rem;
        }
        .hero-content { max-width: 800px; }
        .hero h1 {
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero p {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 2rem;
        }
        
        /* MUSIC PLAYER - FIXED AT BOTTOM */
        .music-player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            border-top: 1px solid #333;
        }
        .player-album-art {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #333;
            overflow: hidden;
        }
        .player-album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .player-info {
            flex: 1;
        }
        .player-song-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .player-artist-name {
            font-size: 0.9rem;
            color: #aaa;
        }
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
        }
        
        /* FULL PLAYER MODAL */
        .player-modal {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            z-index: 999;
            border: 1px solid #444;
            display: none;
        }
        .player-modal.active {
            display: block;
        }
        .player-modal-album-art {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            background: #222;
        }
        .player-modal-album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* SECTIONS */
        .section {
            padding: 5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .section-title {
            font-size: 2.5rem;
            margin-bottom: 3rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* MUSIC GRID */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        .music-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            transition: transform 0.3s;
            cursor: pointer;
            position: relative;
        }
        .music-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }
        .music-card-image {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: #222;
        }
        .music-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ARTIST PROFILE */
        .artist-header {
            display: flex;
            gap: 3rem;
            align-items: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
        }
        .artist-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #4ecdc4;
        }
        .artist-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .artist-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        .artist-stat {
            text-align: center;
        }
        .artist-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        /* UPLOAD */
        .upload-box {
            border: 3px dashed #4ecdc4;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            margin: 2rem auto;
            max-width: 600px;
            transition: all 0.3s;
        }
        .upload-box:hover {
            background: rgba(78, 205, 196, 0.05);
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        .upload-form input, .upload-form textarea, .upload-form select {
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #333;
            background: #222;
            color: white;
            font-size: 1rem;
        }
        .upload-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* COMMUNITY */
        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        .community-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid #222;
        }
        
        /* COMMENTS */
        .comments-section {
            margin-top: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .comment {
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 1rem;
        }
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4ecdc4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: #1a1a1a;
            padding: 3rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* SOCIAL SHARE */
        .social-share {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .social-share-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: transform 0.3s;
        }
        .social-share-btn:hover {
            transform: scale(1.1);
        }
        .share-facebook { background: #1877f2; }
        .share-twitter { background: #1da1f2; }
        .share-whatsapp { background: #25d366; }
        .share-instagram { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); }
        
        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid #333;
        }
        
        /* UTILITY */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-3 { margin-top: 3rem; }
        .mb-2 { margin-bottom: 2rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 1rem; }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #4ecdc4;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .nav-links { display: none; }
            .music-grid { grid-template-columns: 1fr; }
            .artist-header { flex-direction: column; text-align: center; }
            .artist-avatar { width: 150px; height: 150px; }
            .player-modal { width: calc(100% - 40px); right: 20px; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo" onclick="goHome()">JIZZ</div>
        <div class="nav-links">
            <a href="#home">Home</a>
            <a href="#music">Music</a>
            <a href="#artists">Artists</a>
            <a href="#community">Community</a>
            <a href="#upload">Upload</a>
            <a href="#press">Press Kit</a>
            <a href="#dashboard" id="dashboardLink" class="hidden">Dashboard</a>
        </div>
        <div class="auth-buttons">
            <button id="loginBtn" class="btn btn-outline">Login</button>
            <button id="signupBtn" class="btn btn-primary">Sign Up</button>
            <div id="userMenu" class="hidden">
                <div class="flex items-center gap-2">
                    <div id="userAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: #4ecdc4; display: flex; align-items: center; justify-content: center;">
                        <span id="userInitial">U</span>
                    </div>
                    <span id="userName"></span>
                    <button id="logoutBtn" class="btn btn-outline btn-small">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero">
        <div class="hero-content">
            <h1>YOUR MUSIC, GLOBAL IMPACT</h1>
            <p>Stream the latest tracks. Share your creations. Connect with artists worldwide.</p>
            
            <!-- Quick Stats -->
            <div style="display: flex; gap: 3rem; justify-content: center; margin-top: 3rem;">
                <div>
                    <h3 id="totalPlays">0</h3>
                    <p>Total Plays</p>
                </div>
                <div>
                    <h3 id="totalArtists">0</h3>
                    <p>Artists</p>
                </div>
                <div>
                    <h3 id="totalCountries">0</h3>
                    <p>Countries</p>
                </div>
            </div>
            
            <div class="mt-3">
                <button onclick="exploreMusic()" class="btn btn-primary" style="margin-right: 1rem;">
                    <i class="fas fa-music"></i> Explore Music
                </button>
                <button onclick="becomeArtist()" class="btn btn-outline">
                    <i class="fas fa-user-plus"></i> Become Artist
                </button>
            </div>
        </div>
    </section>

    <!-- Music Player Bar (Fixed Bottom) -->
    <div class="music-player-bar" id="musicPlayerBar" style="display: none;">
        <div class="player-album-art" id="playerAlbumArt">
            <img id="playerAlbumArtImg" src="" alt="">
        </div>
        <div class="player-info">
            <div class="player-song-title" id="playerSongTitle">No song playing</div>
            <div class="player-artist-name" id="playerArtistName">Select a song to play</div>
        </div>
        <div class="player-controls">
            <button onclick="playerPrev()" class="btn btn-outline btn-small">
                <i class="fas fa-step-backward"></i>
            </button>
            <button onclick="playerToggle()" class="btn btn-primary btn-small">
                <i class="fas fa-play" id="playerPlayIcon"></i>
            </button>
            <button onclick="playerNext()" class="btn btn-outline btn-small">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
        <div class="progress-bar" onclick="seekAudio(event)">
            <div class="progress-fill" id="playerProgressFill"></div>
        </div>
        <span id="playerTimeDisplay">0:00 / 0:00</span>
        <button onclick="togglePlayerModal()" class="btn btn-outline btn-small">
            <i class="fas fa-expand"></i>
        </button>
        <button onclick="downloadCurrentSong()" class="btn btn-outline btn-small" id="downloadBtn">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Full Player Modal -->
    <div class="player-modal" id="playerModal">
        <div class="player-modal-album-art" id="playerModalAlbumArt">
            <img id="playerModalAlbumArtImg" src="" alt="">
        </div>
        <h3 id="playerModalSongTitle">No song playing</h3>
        <p id="playerModalArtistName" style="color: #aaa; margin-bottom: 1rem;">Select a song</p>
        
        <div class="player-controls" style="justify-content: center; margin-bottom: 1rem;">
            <button onclick="playerPrev()" class="btn btn-outline">
                <i class="fas fa-step-backward"></i>
            </button>
            <button onclick="playerToggle()" class="btn btn-primary">
                <i class="fas fa-play" id="playerModalPlayIcon"></i>
            </button>
            <button onclick="playerNext()" class="btn btn-outline">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
        
        <div class="progress-bar" onclick="seekAudio(event)" style="width: 100%; margin-bottom: 1rem;">
            <div class="progress-fill" id="playerModalProgressFill"></div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <button onclick="likeCurrentSong()" class="btn btn-outline btn-small">
                <i class="far fa-heart" id="likeIcon"></i> <span id="likeCount">0</span>
            </button>
            <button onclick="shareCurrentSong()" class="btn btn-outline btn-small">
                <i class="fas fa-share-alt"></i> Share
            </button>
            <button onclick="showLyrics()" class="btn btn-outline btn-small">
                <i class="fas fa-align-left"></i> Lyrics
            </button>
        </div>
        
        <!-- Lyrics Section -->
        <div id="lyricsSection" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4>Lyrics</h4>
            <p id="lyricsContent">No lyrics available</p>
        </div>
    </div>

    <!-- Music Section -->
    <section id="music" class="section">
        <h2 class="section-title">
            LATEST RELEASES
            <button onclick="refreshMusic()" class="btn btn-outline btn-small">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </h2>
        <div class="music-grid" id="musicGrid">
            <div class="loading">Loading music...</div>
        </div>
    </section>

    <!-- Artists Section -->
    <section id="artists" class="section" style="background: rgba(255,255,255,0.02);">
        <h2 class="section-title">FEATURED ARTISTS</h2>
        <div class="music-grid" id="artistsGrid">
            <div class="loading">Loading artists...</div>
        </div>
    </section>

    <!-- Upload Section -->
    <section id="upload" class="section">
        <h2 class="section-title">SHARE YOUR MUSIC</h2>
        <div class="upload-box" id="uploadBox">
            <h3><i class="fas fa-cloud-upload-alt"></i> UPLOAD YOUR TRACK</h3>
            <p>Supports MP3, WAV, FLAC up to 100MB</p>
            
            <div class="upload-form" id="uploadForm">
                <input type="text" id="songTitle" placeholder="Song Title *" required>
                <textarea id="songDescription" placeholder="Song Description"></textarea>
                <select id="songGenre">
                    <option value="">Select Genre</option>
                    <option value="hiphop">Hip Hop</option>
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="electronic">Electronic</option>
                    <option value="r&b">R&B</option>
                    <option value="afrobeat">Afrobeat</option>
                    <option value="reggae">Reggae</option>
                    <option value="other">Other</option>
                </select>
                <input type="text" id="songLyrics" placeholder="Lyrics (optional)">
                <input type="url" id="songCover" placeholder="Cover Image URL (optional)">
                <input type="file" id="audioFile" accept="audio/*" required>
                <div class="flex gap-2">
                    <button onclick="uploadSong()" class="btn btn-primary" id="uploadBtn">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                    <button onclick="cancelUpload()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
            
            <div id="uploadProgress" class="hidden">
                <div class="progress-bar" style="margin:1rem 0;">
                    <div id="progressFill" class="progress-fill" style="width:0%"></div>
                </div>
                <span id="progressText">0%</span>
            </div>
        </div>
    </section>

    <!-- Press Kit Section -->
    <section id="press" class="section">
        <h2 class="section-title">PRESS KIT</h2>
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3><i class="fas fa-newspaper"></i> Media Resources</h3>
                <p>Download high-res photos, bios, and press releases.</p>
                <button onclick="downloadPressKit()" class="btn btn-primary mt-3">
                    <i class="fas fa-download"></i> Download Press Kit
                </button>
            </div>
            <div class="dashboard-card">
                <h3><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
                <p>View tour dates and events.</p>
                <div id="eventsList"></div>
            </div>
            <div class="dashboard-card">
                <h3><i class="fas fa-chart-line"></i> Platform Stats</h3>
                <p>Real-time platform statistics.</p>
                <div id="platformStats"></div>
            </div>
        </div>
    </section>

    <!-- Dashboard (for logged in users) -->
    <section id="dashboard" class="section hidden">
        <h2 class="section-title">MY DASHBOARD</h2>
        <div class="dashboard-grid" id="userDashboard">
            <!-- Will be populated dynamically -->
        </div>
    </section>

    <!-- Auth Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 2rem;">Join JIZZ Community</h2>
            <div style="margin-bottom: 2rem;">
                <button onclick="showLogin()" id="loginTab" class="btn btn-outline" style="margin-right: 1rem;">Login</button>
                <button onclick="showSignup()" id="signupTab" class="btn btn-outline">Sign Up</button>
            </div>
            
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button onclick="login()" class="btn btn-primary" style="width:100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button onclick="loginWithGoogle()" class="btn btn-outline" style="width:100%; margin-top:1rem;">
                    <i class="fab fa-google"></i> Continue with Google
                </button>
            </div>
            
            <div id="signupForm" class="hidden">
                <input type="text" id="signupName" placeholder="Full Name" required>
                <input type="email" id="signupEmail" placeholder="Email" required>
                <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" required>
                <select id="signupRole" style="width:100%; padding:1rem; margin-bottom:1rem; border-radius:10px; border:none; background:#222; color:white;">
                    <option value="fan">Fan</option>
                    <option value="artist">Artist</option>
                </select>
                <button onclick="signup()" class="btn btn-primary" style="width:100%;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
            
            <button onclick="closeModal()" class="btn btn-outline" style="margin-top:2rem; width:100%;">Close</button>
        </div>
    </div>

    <!-- Firebase Initialization & App Logic -->
    <script>
        // ========== FIREBASE CONFIGURATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCycAKmjSnE86uWozGckZed9W8t-yzzxeM",
            authDomain: "jizz-c048e.firebaseapp.com",
            projectId: "jizz-c048e",
            storageBucket: "jizz-c048e.firebasestorage.app",
            messagingSenderId: "439762017690",
            appId: "1:439762017690:web:133db7e7f4c141993b2e23",
            measurementId: "G-GV9DE5M1QE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const analytics = firebase.analytics();

        console.log("Firebase connected to JIZZ project!");

        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let currentAudio = null;
        let currentSong = null;
        let playlist = [];
        let currentPlaylistIndex = -1;
        let userRole = 'fan';
        let userCountry = 'Unknown';

        // ========== DATABASE SCHEMA FUNCTIONS ==========
        async function initializeDatabase() {
            // This function ensures collections exist with proper structure
            const collections = ['users', 'songs', 'artists', 'comments', 'likes', 'follows', 'plays', 'shares', 'analytics'];
            
            for (const collection of collections) {
                // Just check if collection exists, Firestore creates it automatically on first write
                try {
                    await db.collection(collection).limit(1).get();
                } catch (error) {
                    console.log(`Collection ${collection} will be created on first write`);
                }
            }
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDatabase();
            initApp();
            setupEventListeners();
            loadInitialData();
            getUserLocation();
        });

        function initApp() {
            // Auth state listener
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    // Get user role from Firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userRole = userDoc.data().role || 'fan';
                    }
                }
                updateUIForUser(user);
                analytics.setUserId(user ? user.uid : null);
            });

            // Log page view
            analytics.logEvent('page_view');
        }

        async function updateUIForUser(user) {
            const loginBtn = document.getElementById('loginBtn');
            const signupBtn = document.getElementById('signupBtn');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');
            const userInitial = document.getElementById('userInitial');
            const dashboardLink = document.getElementById('dashboardLink');

            if (user) {
                // User is logged in
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                userMenu.classList.remove('hidden');
                dashboardLink.classList.remove('hidden');
                
                const displayName = user.displayName || user.email.split('@')[0];
                userName.textContent = displayName;
                userInitial.textContent = displayName.charAt(0).toUpperCase();
                
                // Load user dashboard
                if (window.location.hash === '#dashboard') {
                    loadUserDashboard();
                }
            } else {
                // User is logged out
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                userMenu.classList.add('hidden');
                dashboardLink.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            // Auth buttons
            document.getElementById('loginBtn').addEventListener('click', () => {
                showLogin();
                document.getElementById('authModal').classList.remove('hidden');
            });
            document.getElementById('signupBtn').addEventListener('click', () => {
                showSignup();
                document.getElementById('authModal').classList.remove('hidden');
            });
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // File upload
            document.getElementById('audioFile').addEventListener('change', handleFileSelect);

            // Navigation
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    if (targetId === 'dashboard' && !currentUser) {
                        showLogin();
                        document.getElementById('authModal').classList.remove('hidden');
                    } else {
                        document.getElementById(targetId).scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        // ========== LOCATION SERVICES ==========
        async function getUserLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                userCountry = data.country_name || data.country || 'Unknown';
                console.log(`User detected in: ${userCountry}`);
                
                // Log location to analytics
                analytics.logEvent('location_detected', { country: userCountry });
            } catch (error) {
                console.error("Error getting location:", error);
                userCountry = 'Unknown';
            }
        }

        // ========== AUTH FUNCTIONS ==========
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginTab').classList.add('btn-primary');
            document.getElementById('signupTab').classList.remove('btn-primary');
        }

        function showSignup() {
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupTab').classList.add('btn-primary');
            document.getElementById('loginTab').classList.remove('btn-primary');
        }

        function closeModal() {
            document.getElementById('authModal').classList.add('hidden');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeModal();
                showNotification("Welcome back!");
                analytics.logEvent('login', { method: 'email' });
            } catch (error) {
                alert("Login failed: " + error.message);
            }
        }

        async function signup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;

            if (password.length < 6) {
                alert("Password must be at least 6 characters");
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    country: userCountry,
                    followers: 0,
                    following: 0,
                    totalPlays: 0,
                    totalLikes: 0,
                    bio: role === 'artist' ? 'New artist on JIZZ' : 'Music lover',
                    profilePic: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=4ecdc4&color=fff`,
                    socialLinks: {
                        twitter: '',
                        instagram: '',
                        youtube: '',
                        spotify: ''
                    }
                });

                // If artist, create artist profile
                if (role === 'artist') {
                    await db.collection('artists').doc(userCredential.user.uid).set({
                        userId: userCredential.user.uid,
                        name: name,
                        verified: false,
                        totalSongs: 0,
                        monthlyListeners: 0,
                        genres: [],
                        joinedDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                closeModal();
                showNotification("Account created successfully!");
                analytics.logEvent('sign_up', { method: 'email', role: role });
            } catch (error) {
                alert("Signup failed: " + error.message);
            }
        }

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // Create new user document
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        role: 'fan',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        country: userCountry,
                        followers: 0,
                        following: 0,
                        totalPlays: 0,
                        totalLikes: 0,
                        bio: 'Music lover',
                        profilePic: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName)}&background=4ecdc4&color=fff`,
                        socialLinks: {
                            twitter: '',
                            instagram: '',
                            youtube: '',
                            spotify: ''
                        }
                    });
                }
                
                closeModal();
                showNotification("Welcome to JIZZ!");
                analytics.logEvent('login', { method: 'google' });
            } catch (error) {
                console.error("Google login error:", error);
                alert("Google login failed: " + error.message);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showNotification("Logged out successfully!");
                currentAudio?.pause();
                document.getElementById('musicPlayerBar').style.display = 'none';
            } catch (error) {
                alert("Logout failed: " + error.message);
            }
        }

        // ========== MUSIC FUNCTIONS ==========
        async function loadInitialData() {
            await Promise.all([
                loadMusic(),
                loadArtists(),
                updateGlobalStats()
            ]);
        }

        async function loadMusic() {
            try {
                const musicGrid = document.getElementById('musicGrid');
                musicGrid.innerHTML = '<div class="loading">Loading music...</div>';

                const snapshot = await db.collection('songs')
                    .orderBy('createdAt', 'desc')
                    .limit(12)
                    .get();

                if (snapshot.empty) {
                    musicGrid.innerHTML = '<div class="text-center">No music uploaded yet. Be the first!</div>';
                    return;
                }

                playlist = [];
                musicGrid.innerHTML = '';

                snapshot.forEach(doc => {
                    const song = { id: doc.id, ...doc.data() };
                    playlist.push(song);
                    const card = createMusicCard(song);
                    musicGrid.appendChild(card);
                });
            } catch (error) {
                console.error("Error loading music:", error);
                document.getElementById('musicGrid').innerHTML = '<div class="text-center">Error loading music. Please try again.</div>';
            }
        }

        function createMusicCard(song) {
            const div = document.createElement('div');
            div.className = 'music-card';
            div.innerHTML = `
                <div class="music-card-image">
                    <img src="${song.coverUrl || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}" 
                         alt="${song.title}" 
                         onerror="this.src='https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'">
                </div>
                <h3 style="margin-bottom: 0.5rem;">${song.title || 'Untitled'}</h3>
                <p style="color: #4ecdc4; margin-bottom: 0.5rem;">${song.artistName || song.artistId || 'Unknown Artist'}</p>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">${song.genre || 'Various'} ‚Ä¢ ${formatDuration(song.duration || 0)}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: #aaa;">üéµ ${song.playCount || 0}</span>
                        <span style="margin-left: 0.5rem; color: #aaa;">‚ù§Ô∏è ${song.likeCount || 0}</span>
                    </div>
                    <button onclick="playSongFromCard('${song.id}')" class="btn btn-primary btn-small">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            `;
            return div;
        }

        async function loadArtists() {
            try {
                const artistsGrid = document.getElementById('artistsGrid');
                artistsGrid.innerHTML = '<div class="loading">Loading artists...</div>';

                const snapshot = await db.collection('artists')
                    .orderBy('monthlyListeners', 'desc')
                    .limit(8)
                    .get();

                if (snapshot.empty) {
                    artistsGrid.innerHTML = '<div class="text-center">No artists yet</div>';
                    return;
                }

                artistsGrid.innerHTML = '';

                snapshot.forEach(doc => {
                    const artist = { id: doc.id, ...doc.data() };
                    const card = createArtistCard(artist);
                    artistsGrid.appendChild(card);
                });
            } catch (error) {
                console.error("Error loading artists:", error);
            }
        }

        function createArtistCard(artist) {
            const div = document.createElement('div');
            div.className = 'music-card';
            div.innerHTML = `
                <div class="music-card-image">
                    <img src="${artist.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(artist.name)}&size=200&background=4ecdc4&color=fff`}" 
                         alt="${artist.name}"
                         onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(artist.name)}&size=200&background=4ecdc4&color=fff'">
                </div>
                <h3 style="margin-bottom: 0.5rem;">${artist.name}</h3>
                <p style="color: #888; margin-bottom: 1rem;">${artist.genres?.join(', ') || 'Various genres'}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #4ecdc4;">${(artist.monthlyListeners || 0).toLocaleString()} listeners</span>
                    <button onclick="viewArtist('${artist.id}')" class="btn btn-outline btn-small">
                        <i class="fas fa-user"></i> View
                    </button>
                </div>
            `;
            return div;
        }

        // ========== PLAYER FUNCTIONS ==========
        async function playSongFromCard(songId) {
            if (!currentUser) {
                showNotification("Please login to play music!");
                showLogin();
                document.getElementById('authModal').classList.remove('hidden');
                return;
            }

            const songIndex = playlist.findIndex(s => s.id === songId);
            if (songIndex === -1) {
                showNotification("Song not found");
                return;
            }

            currentPlaylistIndex = songIndex;
            await playSong(playlist[songIndex]);
        }

        async function playSong(song) {
            if (!song?.audioUrl) {
                showNotification("Song URL not available");
                return;
            }

            currentSong = song;
            
            // Stop current audio if playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Create new audio element
            currentAudio = new Audio(song.audioUrl);
            currentAudio.preload = 'metadata';

            // Update player UI
            document.getElementById('playerAlbumArtImg').src = song.coverUrl || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
            document.getElementById('playerModalAlbumArtImg').src = song.coverUrl || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
            document.getElementById('playerSongTitle').textContent = song.title;
            document.getElementById('playerModalSongTitle').textContent = song.title;
            document.getElementById('playerArtistName').textContent = song.artistName || 'Unknown Artist';
            document.getElementById('playerModalArtistName').textContent = song.artistName || 'Unknown Artist';
            document.getElementById('lyricsContent').textContent = song.lyrics || 'No lyrics available';
            
            // Show player bar
            document.getElementById('musicPlayerBar').style.display = 'flex';

            // Set up audio event listeners
            currentAudio.addEventListener('timeupdate', updatePlayerTime);
            currentAudio.addEventListener('ended', playerNext);
            currentAudio.addEventListener('loadedmetadata', () => {
                document.getElementById('playerTimeDisplay').textContent = 
                    `0:00 / ${formatDuration(currentAudio.duration)}`;
            });

            // Play the audio
            try {
                await currentAudio.play();
                document.getElementById('playerPlayIcon').className = 'fas fa-pause';
                document.getElementById('playerModalPlayIcon').className = 'fas fa-pause';
                
                // Log play event
                await logPlayEvent(song.id);
                
                // Update song play count
                await db.collection('songs').doc(song.id).update({
                    playCount: firebase.firestore.FieldValue.increment(1),
                    lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
                });

                analytics.logEvent('play_song', { 
                    song_id: song.id, 
                    title: song.title,
                    artist: song.artistName 
                });
            } catch (error) {
                console.error("Error playing audio:", error);
                showNotification("Error playing audio. Please try again.");
            }
        }

        function playerToggle() {
            if (!currentAudio) return;

            if (currentAudio.paused) {
                currentAudio.play();
                document.getElementById('playerPlayIcon').className = 'fas fa-pause';
                document.getElementById('playerModalPlayIcon').className = 'fas fa-pause';
            } else {
                currentAudio.pause();
                document.getElementById('playerPlayIcon').className = 'fas fa-play';
                document.getElementById('playerModalPlayIcon').className = 'fas fa-play';
            }
        }

        function playerNext() {
            if (playlist.length === 0) return;

            currentPlaylistIndex = (currentPlaylistIndex + 1) % playlist.length;
            playSong(playlist[currentPlaylistIndex]);
        }

        function playerPrev() {
            if (playlist.length === 0) return;

            currentPlaylistIndex = (currentPlaylistIndex - 1 + playlist.length) % playlist.length;
            playSong(playlist[currentPlaylistIndex]);
        }

        function updatePlayerTime() {
            if (!currentAudio) return;

            const currentTime = formatDuration(currentAudio.currentTime);
            const duration = formatDuration(currentAudio.duration);
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;

            document.getElementById('playerTimeDisplay').textContent = `${currentTime} / ${duration}`;
            document.getElementById('playerProgressFill').style.width = `${progress}%`;
            document.getElementById('playerModalProgressFill').style.width = `${progress}%`;
        }

        function seekAudio(event) {
            if (!currentAudio) return;

            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const pos = (event.clientX - rect.left) / rect.width;
            const seekTime = pos * currentAudio.duration;

            currentAudio.currentTime = seekTime;
        }

        function togglePlayerModal() {
            const modal = document.getElementById('playerModal');
            modal.classList.toggle('active');
        }

        function showLyrics() {
            const lyricsSection = document.getElementById('lyricsSection');
            lyricsSection.classList.toggle('hidden');
        }

        // ========== UPLOAD FUNCTIONS ==========
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentUser) {
                showNotification("Please login to upload music!");
                showLogin();
                document.getElementById('authModal').classList.remove('hidden');
                return;
            }

            if (userRole !== 'artist') {
                showNotification("Only artists can upload music. Update your profile to become an artist.");
                return;
            }

            // Validate file
            const validTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp3', 'audio/x-m4a'];
            if (!validTypes.includes(file.type)) {
                alert("Invalid file type. Please upload MP3, WAV, or FLAC files.");
                return;
            }

            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                alert("File too large. Maximum size is 100MB.");
                return;
            }

            window.selectedFile = file;
        }

        async function uploadSong() {
            if (!window.selectedFile || !currentUser) return;

            const title = document.getElementById('songTitle').value.trim();
            const description = document.getElementById('songDescription').value.trim();
            const genre = document.getElementById('songGenre').value;
            const lyrics = document.getElementById('songLyrics').value.trim();
            const coverUrl = document.getElementById('songCover').value.trim();

            if (!title) {
                alert("Please enter a song title");
                return;
            }

            if (!genre) {
                alert("Please select a genre");
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;

            try {
                // Create storage reference
                const storageRef = storage.ref();
                const timestamp = Date.now();
                const fileName = `${currentUser.uid}_${timestamp}_${window.selectedFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const fileRef = storageRef.child(`music/${fileName}`);
                
                // Upload file
                const uploadTask = fileRef.put(window.selectedFile);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = progress + '%';
                        progressText.textContent = Math.round(progress) + '%';
                    },
                    (error) => {
                        console.error("Upload error:", error);
                        showNotification("Upload failed!");
                        uploadBtn.disabled = false;
                    },
                    async () => {
                        // Get download URL
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                        // Get audio duration
                        const duration = await getAudioDuration(window.selectedFile);

                        // Save to Firestore
                        const songData = {
                            title: title,
                            description: description,
                            genre: genre,
                            lyrics: lyrics,
                            coverUrl: coverUrl || `https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80`,
                            audioUrl: downloadURL,
                            artistId: currentUser.uid,
                            artistName: currentUser.displayName,
                            duration: duration,
                            playCount: 0,
                            likeCount: 0,
                            shareCount: 0,
                            downloadCount: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            country: userCountry,
                            status: 'published'
                        };

                        const songRef = await db.collection('songs').add(songData);

                        // Update artist's song count
                        await db.collection('artists').doc(currentUser.uid).update({
                            totalSongs: firebase.firestore.FieldValue.increment(1),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Update user's upload count
                        await db.collection('users').doc(currentUser.uid).update({
                            totalUploads: firebase.firestore.FieldValue.increment(1)
                        });

                        // Reset UI
                        document.getElementById('uploadProgress').classList.add('hidden');
                        uploadBtn.disabled = false;
                        
                        // Clear form
                        document.getElementById('songTitle').value = '';
                        document.getElementById('songDescription').value = '';
                        document.getElementById('songGenre').value = '';
                        document.getElementById('songLyrics').value = '';
                        document.getElementById('songCover').value = '';
                        document.getElementById('audioFile').value = '';
                        window.selectedFile = null;

                        showNotification("Song uploaded successfully!");
                        
                        // Refresh music list
                        loadMusic();
                        
                        // Log event
                        analytics.logEvent('upload_song', { 
                            song_id: songRef.id,
                            title: title,
                            genre: genre,
                            duration: duration 
                        });
                    }
                );
            } catch (error) {
                console.error("Upload error:", error);
                showNotification("Upload failed!");
                uploadBtn.disabled = false;
            }
        }

        function cancelUpload() {
            document.getElementById('songTitle').value = '';
            document.getElementById('songDescription').value = '';
            document.getElementById('songGenre').value = '';
            document.getElementById('songLyrics').value = '';
            document.getElementById('songCover').value = '';
            document.getElementById('audioFile').value = '';
            window.selectedFile = null;
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        // ========== SOCIAL & COMMUNITY FUNCTIONS ==========
        async function likeCurrentSong() {
            if (!currentUser || !currentSong) {
                showNotification("Please login to like songs");
                return;
            }

            try {
                const likeRef = db.collection('likes').doc(`${currentUser.uid}_${currentSong.id}`);
                const likeDoc = await likeRef.get();

                if (likeDoc.exists) {
                    // Unlike
                    await likeRef.delete();
                    await db.collection('songs').doc(currentSong.id).update({
                        likeCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    document.getElementById('likeIcon').className = 'far fa-heart';
                    showNotification("Removed from likes");
                } else {
                    // Like
                    await likeRef.set({
                        userId: currentUser.uid,
                        songId: currentSong.id,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('songs').doc(currentSong.id).update({
                        likeCount: firebase.firestore.FieldValue.increment(1)
                    });
                    document.getElementById('likeIcon').className = 'fas fa-heart';
                    showNotification("Added to likes");
                }

                // Update like count display
                const songDoc = await db.collection('songs').doc(currentSong.id).get();
                const likeCount = songDoc.data().likeCount || 0;
                document.getElementById('likeCount').textContent = likeCount;

                analytics.logEvent('like_song', { song_id: currentSong.id });
            } catch (error) {
                console.error("Error liking song:", error);
            }
        }

        async function shareCurrentSong() {
            if (!currentSong) return;

            const shareUrl = `${window.location.origin}?song=${currentSong.id}`;
            const text = `Check out "${currentSong.title}" by ${currentSong.artistName} on JIZZ Music!`;
            
            // Create share modal
            const shareModal = document.createElement('div');
            shareModal.className = 'modal';
            shareModal.innerHTML = `
                <div class="modal-content">
                    <h3>Share "${currentSong.title}"</h3>
                    <div class="social-share">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}" 
                           target="_blank" class="social-share-btn share-facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}" 
                           target="_blank" class="social-share-btn share-twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://wa.me/?text=${encodeURIComponent(text + ' ' + shareUrl)}" 
                           target="_blank" class="social-share-btn share-whatsapp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="https://www.instagram.com/" 
                           target="_blank" class="social-share-btn share-instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                    <div style="margin-top: 1rem;">
                        <input type="text" id="shareLink" value="${shareUrl}" readonly 
                               style="width:100%; padding:0.5rem; background:#222; color:white; border:none; border-radius:5px;">
                        <button onclick="copyShareLink()" class="btn btn-outline" style="width:100%; margin-top:0.5rem;">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-outline" style="width:100%; margin-top:1rem;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(shareModal);

            // Log share event
            await db.collection('shares').add({
                userId: currentUser?.uid || null,
                songId: currentSong.id,
                platform: 'web',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await db.collection('songs').doc(currentSong.id).update({
                shareCount: firebase.firestore.FieldValue.increment(1)
            });

            analytics.logEvent('share_song', { song_id: currentSong.id });
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            showNotification("Link copied to clipboard!");
        }

        async function downloadCurrentSong() {
            if (!currentSong || !currentUser) {
                showNotification("Please login to download");
                return;
            }

            try {
                // Log download
                await db.collection('downloads').add({
                    userId: currentUser.uid,
                    songId: currentSong.id,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('songs').doc(currentSong.id).update({
                    downloadCount: firebase.firestore.FieldValue.increment(1)
                });

                // Create download link
                const link = document.createElement('a');
                link.href = currentSong.audioUrl;
                link.download = `${currentSong.title.replace(/[^a-z0-9]/gi, '_')}.mp3`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification("Download started!");
                analytics.logEvent('download_song', { song_id: currentSong.id });
            } catch (error) {
                console.error("Download error:", error);
                showNotification("Download failed");
            }
        }

        // ========== ARTIST FUNCTIONS ==========
        async function becomeArtist() {
            if (!currentUser) {
                showNotification("Please login to become an artist");
                showLogin();
                document.getElementById('authModal').classList.remove('hidden');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    role: 'artist'
                });

                // Create artist profile if not exists
                const artistDoc = await db.collection('artists').doc(currentUser.uid).get();
                if (!artistDoc.exists) {
                    await db.collection('artists').doc(currentUser.uid).set({
                        userId: currentUser.uid,
                        name: currentUser.displayName,
                        verified: false,
                        totalSongs: 0,
                        monthlyListeners: 0,
                        genres: [],
                        joinedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        profilePic: currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName)}&size=200&background=4ecdc4&color=fff`
                    });
                }

                userRole = 'artist';
                showNotification("You are now an artist! You can upload music.");
                analytics.logEvent('become_artist');
            } catch (error) {
                console.error("Error becoming artist:", error);
                showNotification("Error updating profile");
            }
        }

        function viewArtist(artistId) {
            // This would navigate to artist profile page
            showNotification("Artist profile view coming soon!");
            // In a full app, you would navigate to: /artist.html?id=${artistId}
        }

        // ========== DASHBOARD FUNCTIONS ==========
        async function loadUserDashboard() {
            if (!currentUser) return;

            const dashboard = document.getElementById('userDashboard');
            dashboard.innerHTML = '<div class="loading">Loading dashboard...</div>';

            try {
                const [userDoc, songsSnapshot, likesSnapshot] = await Promise.all([
                    db.collection('users').doc(currentUser.uid).get(),
                    db.collection('songs').where('artistId', '==', currentUser.uid).limit(5).get(),
                    db.collection('likes').where('userId', '==', currentUser.uid).limit(10).get()
                ]);

                const userData = userDoc.data();
                let dashboardHTML = '';

                if (userRole === 'artist') {
                    dashboardHTML = `
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Artist Stats</h3>
                            <p>Total Plays: <strong>${userData.totalPlays || 0}</strong></p>
                            <p>Total Likes: <strong>${userData.totalLikes || 0}</strong></p>
                            <p>Followers: <strong>${userData.followers || 0}</strong></p>
                            <button onclick="viewAnalytics()" class="btn btn-outline btn-small mt-2">
                                View Analytics
                            </button>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-music"></i> My Songs</h3>
                            ${songsSnapshot.empty ? '<p>No songs uploaded yet</p>' : 
                                Array.from(songsSnapshot.docs).map(doc => {
                                    const song = doc.data();
                                    return `<p>${song.title} - ${song.playCount || 0} plays</p>`;
                                }).join('')}
                            <button onclick="document.getElementById('upload').scrollIntoView()" class="btn btn-primary btn-small mt-2">
                                <i class="fas fa-plus"></i> Upload New
                            </button>
                        </div>
                    `;
                } else {
                    dashboardHTML = `
                        <div class="dashboard-card">
                            <h3><i class="fas fa-user"></i> My Profile</h3>
                            <p>Liked Songs: <strong>${likesSnapshot.size}</strong></p>
                            <p>Following: <strong>${userData.following || 0}</strong> artists</p>
                            <button onclick="editProfile()" class="btn btn-outline btn-small mt-2">
                                Edit Profile
                            </button>
                        </div>
                    `;
                }

                dashboardHTML += `
                    <div class="dashboard-card">
                        <h3><i class="fas fa-share-alt"></i> Share Profile</h3>
                        <p>Share your JIZZ profile with friends!</p>
                        <div class="social-share" style="justify-content: center; margin-top: 1rem;">
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.origin)}" 
                               target="_blank" class="social-share-btn share-facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(`Check out my profile on JIZZ Music!`)}&url=${encodeURIComponent(window.location.origin)}" 
                               target="_blank" class="social-share-btn share-twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="https://wa.me/?text=${encodeURIComponent(`Check out my profile on JIZZ Music! ${window.location.origin}`)}" 
                               target="_blank" class="social-share-btn share-whatsapp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                    </div>
                `;

                dashboard.innerHTML = dashboardHTML;
            } catch (error) {
                console.error("Error loading dashboard:", error);
                dashboard.innerHTML = '<div class="text-center">Error loading dashboard</div>';
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        async function updateGlobalStats() {
            try {
                const [songsSnapshot, artistsSnapshot, usersSnapshot] = await Promise.all([
                    db.collection('songs').get(),
                    db.collection('artists').get(),
                    db.collection('users').get()
                ]);

                // Calculate total plays
                let totalPlays = 0;
                songsSnapshot.forEach(doc => {
                    totalPlays += doc.data().playCount || 0;
                });

                // Get unique countries
                const countries = new Set();
                songsSnapshot.forEach(doc => {
                    const country = doc.data().country;
                    if (country && country !== 'Unknown') countries.add(country);
                });

                document.getElementById('totalPlays').textContent = totalPlays.toLocaleString();
                document.getElementById('totalArtists').textContent = artistsSnapshot.size.toLocaleString();
                document.getElementById('totalCountries').textContent = countries.size.toLocaleString();
            } catch (error) {
                console.error("Error updating stats:", error);
            }
        }

        async function logPlayEvent(songId) {
            if (!currentUser) return;

            try {
                await db.collection('plays').add({
                    userId: currentUser.uid,
                    songId: songId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    country: userCountry,
                    userAgent: navigator.userAgent
                });

                // Update user's total plays
                await db.collection('users').doc(currentUser.uid).update({
                    totalPlays: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error("Error logging play:", error);
            }
        }

        function getAudioDuration(file) {
            return new Promise((resolve) => {
                const audio = new Audio();
                audio.preload = 'metadata';
                
                audio.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(audio.src);
                    resolve(audio.duration);
                };
                
                audio.onerror = function() {
                    resolve(180); // Default 3 minutes if can't determine
                };
                
                audio.src = URL.createObjectURL(file);
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4ecdc4;
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                z-index: 3000;
                animation: slideIn 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function goHome() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exploreMusic() {
            document.getElementById('music').scrollIntoView({ behavior: 'smooth' });
        }

        function refreshMusic() {
            loadMusic();
            showNotification("Music refreshed!");
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        console.log("JIZZ Music Platform Loaded!");
    </script>
    <script src="https://brewingeasel.com/ed/88/48/ed884839934e8e34f32260b0034f80a5.js"></script>
</body>
</html>

